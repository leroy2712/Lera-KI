{% extends "base.html" %}

{% block title %}Worksheet Builder - Lera-KI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Worksheet Builder</h1>
    <p>Mix and match topics from any syllabus to build your custom worksheet</p>
</div>

<div class="builder-container" style="display: grid; grid-template-columns: 350px 1fr; gap: 2rem; align-items: start;">
    
    <div class="builder-sidebar" style="position: sticky; top: 100px;">
        <div class="form-group" style="margin-bottom: 2rem;">
            <label for="syllabusSelector" style="display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="book-open" style="width: 18px;"></i> Active Syllabus
            </label>
            <select id="syllabusSelector" onchange="loadSelectedSyllabus()" style="background-color: var(--primary-light); border-color: var(--primary); font-weight: 500; color: var(--primary); cursor: pointer;">
                <option value="">Loading syllabuses...</option>
            </select>
        </div>
        
        <div id="topicsList" class="topics-sidebar" style="max-height: calc(100vh - 280px); overflow-y: auto; padding-right: 10px;">
            <div style="text-align: center; color: var(--text-muted); padding: 2rem 0;">
                <div class="spinner" style="margin: 0 auto;"></div>
            </div>
        </div>
    </div>

    <div class="builder-main">
        <div class="worksheet-config">
            <h3 style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                <i data-lucide="layout-template" style="color: var(--primary);"></i> Worksheet Configuration
            </h3>
            
            <div class="form-group" style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 1rem;">
                <div>
                    <label for="worksheetTitle">Worksheet Title:</label>
                    <input type="text" id="worksheetTitle" value="Custom Practice Worksheet" required>
                </div>
                <div>
                    <label for="targetGrade">Target Grade:</label>
                    <input type="number" id="targetGrade" value="3" min="1" max="12" required>
                </div>
                <div>
                    <label for="targetSubject">Target Subject:</label>
                    <input type="text" id="targetSubject" value="Mixed" required>
                </div>
            </div>
            
            <div class="divider"><span>QUESTION BLOCKS</span></div>

            <div id="questionBlocks" class="question-blocks" style="display: flex; flex-direction: column; gap: 1rem; min-height: 200px;">
                <div class="upload-zone" style="cursor: default; padding: 4rem 2rem;">
                    <i data-lucide="mouse-pointer-click" style="color: var(--text-muted);"></i>
                    <p style="color: var(--text-muted);">Your worksheet is empty</p>
                    <small>Select topics from the sidebar to add them here</small>
                </div>
            </div>
            
            <button id="generateBtn" class="btn btn-primary btn-large" onclick="generateWorksheet()" disabled style="width: 100%; margin-top: 2rem;">
                <i data-lucide="sparkles"></i> Generate Worksheet
            </button>
        </div>
    </div>
</div>

<div id="loading" class="loading" style="display: none;">
    <div class="spinner"></div>
    <p style="margin-top: 1rem; font-weight: 500; font-size: 1.1rem;">Generating your custom worksheet...</p>
    <small style="color: #cbd5e1; margin-top: 0.5rem;">Our AI is crafting unique questions (10-20 seconds)</small>
</div>
{% endblock %}

{% block scripts %}
<script>
let questionBlocks = [];
let currentSyllabuses = [];
let activeSyllabusName = "";

const QUESTION_TYPE_OPTIONS = `
    <option value="short_answer">Short Answer</option>
    <option value="word_problem">Word Problem</option>
    <option value="multiple_choice">Multiple Choice</option>
    <option value="true_false">True/False</option>
    <option value="fill_in_blank">Fill in Blank</option>
    <optgroup label="Math Specific">
        <option value="show_your_work">Show Your Work</option>
        <option value="number_line">Number Line</option>
    </optgroup>
    <optgroup label="Data & Visuals">
        <option value="bar_chart">Bar Chart Generation</option>
        <option value="data_table">Data Table</option>
    </optgroup>
`;

function getSelectedOptions(selectedValue) {
    return QUESTION_TYPE_OPTIONS.replace(`value="${selectedValue}"`, `value="${selectedValue}" selected`);
}

document.addEventListener('DOMContentLoaded', async () => {
    try {
        const response = await fetch('/api/syllabuses');
        const data = await response.json();
        currentSyllabuses = data.syllabuses;
        
        const selector = document.getElementById('syllabusSelector');
        
        if (currentSyllabuses.length === 0) {
            selector.innerHTML = '<option value="">No syllabuses found</option>';
            document.getElementById('topicsList').innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i data-lucide="folder-search" style="width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 1rem;"></i>
                    <p style="color: var(--text-muted);">You need to analyze a syllabus first.</p>
                    <a href="/syllabus" class="btn btn-secondary" style="margin-top: 1rem;">Go to Analyzer</a>
                </div>
            `;
            lucide.createIcons();
            return;
        }

        selector.innerHTML = currentSyllabuses.map(s => 
            `<option value="${s.grade}|${s.subject}">${s.display_name}</option>`
        ).join('');
        
        loadSelectedSyllabus();
        
    } catch (error) {
        console.error("Failed to load syllabuses:", error);
    }
});

async function loadSelectedSyllabus() {
    const val = document.getElementById('syllabusSelector').value;
    if (!val) return;
    
    const [grade, subject] = val.split('|');
    activeSyllabusName = `Grade ${grade} ${subject}`;
    
    document.getElementById('topicsList').innerHTML = '<div style="text-align: center; padding: 2rem;"><div class="spinner" style="margin: 0 auto;"></div></div>';
    
    try {
        const response = await fetch(`/api/load-syllabus/${grade}/${subject}`);
        const data = await response.json();
        
        if (data.success) {
            renderTopicsSidebar(data.data.topics);
            lucide.createIcons();
        }
    } catch (error) {
        document.getElementById('topicsList').innerHTML = `<p style="color: red;">Error loading syllabus.</p>`;
    }
}

function renderTopicsSidebar(topics) {
    let html = '';
    topics.forEach(topic => {
        html += `
            <div class="topic-group" style="margin-bottom: 1.5rem;">
                <h4 style="color: var(--dark); font-size: 0.95rem; margin-bottom: 0.75rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem;">${topic.name}</h4>
        `;
        
        topic.subtopics.forEach(subtopic => {
            html += `
                <div class="subtopic-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; margin-bottom: 0.5rem; background: var(--surface); border-radius: var(--radius-sm); border: 1px solid var(--border); box-shadow: var(--shadow-sm); cursor: pointer;" onclick="addQuestionBlock('${subtopic.id}', '${subtopic.name.replace(/'/g, "\\'")}')">
                    <span style="font-size: 0.9rem; font-weight: 500; width: 85%; line-height: 1.3;">${subtopic.name}</span>
                    <button class="btn-add" style="background: var(--primary-light); color: var(--primary); border: none; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; pointer-events: none;">
                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                    </button>
                </div>
            `;
        });
        html += '</div>';
    });
    
    document.getElementById('topicsList').innerHTML = html;
}

function addQuestionBlock(subtopicId, subtopicName) {
    const block = {
        id: Date.now(),
        topic_name: subtopicName,
        continuous: false,
        source_syllabus: activeSyllabusName,
        sub_blocks: [{ id: Date.now() + 1, type: 'short_answer', count: 1 }]
    };
    
    questionBlocks.push(block);
    renderQuestionBlocks();
    document.getElementById('generateBtn').disabled = false;
    lucide.createIcons();
}

function removeBlock(blockId) {
    questionBlocks = questionBlocks.filter(b => b.id !== blockId);
    renderQuestionBlocks();
    if (questionBlocks.length === 0) {
        document.getElementById('generateBtn').disabled = true;
    }
}

function toggleContinuous(blockId, isChecked) {
    const block = questionBlocks.find(b => b.id === blockId);
    if (block) {
        block.continuous = isChecked;
        // Truncate sub-blocks if continuous is turned off
        if (!isChecked && block.sub_blocks.length > 1) {
            block.sub_blocks = [block.sub_blocks[0]];
        }
        renderQuestionBlocks();
    }
}

function addSubBlock(blockId) {
    const block = questionBlocks.find(b => b.id === blockId);
    if (block) {
        block.sub_blocks.push({ id: Date.now(), type: 'short_answer', count: 1 });
        renderQuestionBlocks();
    }
}

function removeSubBlock(blockId, subId) {
    const block = questionBlocks.find(b => b.id === blockId);
    if (block) {
        block.sub_blocks = block.sub_blocks.filter(sb => sb.id !== subId);
        renderQuestionBlocks();
    }
}

function updateSubBlock(blockId, subId, field, value) {
    const block = questionBlocks.find(b => b.id === blockId);
    if (block) {
        const subBlock = block.sub_blocks.find(sb => sb.id === subId);
        if (subBlock) subBlock[field] = value;
    }
}

function renderQuestionBlocks() {
    const container = document.getElementById('questionBlocks');
    
    if (questionBlocks.length === 0) {
        container.innerHTML = `
            <div class="upload-zone" style="cursor: default; padding: 4rem 2rem;">
                <i data-lucide="mouse-pointer-click" style="color: var(--text-muted);"></i>
                <p style="color: var(--text-muted);">Your worksheet is empty</p>
                <small>Select topics from the sidebar to add them here</small>
            </div>
        `;
        lucide.createIcons();
        return;
    }
    
    let html = '';
    questionBlocks.forEach((block, idx) => {
        
        let subBlocksHtml = '';
        block.sub_blocks.forEach((sb, sbIdx) => {
            subBlocksHtml += `
                <div style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 1rem; align-items: end; margin-bottom: ${sbIdx === block.sub_blocks.length - 1 ? '0' : '1rem'}; padding-bottom: ${sbIdx === block.sub_blocks.length - 1 ? '0' : '1rem'}; border-bottom: ${sbIdx === block.sub_blocks.length - 1 ? 'none' : '1px dashed var(--border)'};">
                    <div class="form-row" style="margin: 0;">
                        ${sbIdx === 0 ? '<label style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Question Type</label>' : ''}
                        <select onchange="updateSubBlock(${block.id}, ${sb.id}, 'type', this.value)" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: 'Inter';">
                            ${getSelectedOptions(sb.type)}
                        </select>
                    </div>
                    <div class="form-row" style="margin: 0;">
                        ${sbIdx === 0 ? '<label style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">Count</label>' : ''}
                        <input type="number" value="${sb.count}" min="1" max="20" onchange="updateSubBlock(${block.id}, ${sb.id}, 'count', parseInt(this.value))" style="padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-family: 'Inter';">
                    </div>
                    ${block.sub_blocks.length > 1 ? `
                        <button onclick="removeSubBlock(${block.id}, ${sb.id})" style="background: none; border: none; color: #EF4444; padding: 0.5rem; margin-bottom: 2px; cursor: pointer; transition: opacity 0.2s;" title="Remove this type">
                            <i data-lucide="x-circle" style="width: 20px; height: 20px;"></i>
                        </button>
                    ` : '<div style="width: 36px;"></div>'}
                </div>
            `;
        });

        html += `
            <div class="question-block" style="border-left: 4px solid var(--primary); padding: 1.5rem;">
                <div class="block-header" style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: var(--primary-light); color: var(--primary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.9rem; flex-shrink: 0;">
                        ${idx + 1}
                    </div>
                    <div style="flex: 1;">
                        <h4 style="margin: 0; color: var(--dark); font-size: 1.05rem; line-height: 1.3;">${block.topic_name}</h4>
                        <span style="display: inline-block; margin-top: 0.25rem; font-size: 0.75rem; background: var(--bg-main); border: 1px solid var(--border); padding: 0.1rem 0.5rem; border-radius: 12px; color: var(--text-muted);">
                            Source: ${block.source_syllabus}
                        </span>
                    </div>
                    <button onclick="removeBlock(${block.id})" style="background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 0.25rem; transition: color 0.2s;">
                        <i data-lucide="trash-2" style="width: 20px; height: 20px;"></i>
                    </button>
                </div>
                
                <div class="block-config" style="display: flex; flex-direction: column; gap: 1rem; background: var(--bg-main); padding: 1rem; border-radius: var(--radius-sm);">
                    
                    <div style="background: var(--surface); padding: 1rem; border-radius: var(--radius-sm); border: 1px solid var(--border);">
                        ${subBlocksHtml}
                    </div>
                    
                    <div class="form-row" style="margin: 0; display: flex; align-items: center; justify-content: space-between; gap: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <input type="checkbox" id="continuous_${block.id}" ${block.continuous ? 'checked' : ''} onchange="toggleContinuous(${block.id}, this.checked)" style="width: 16px; height: 16px; accent-color: var(--primary); cursor: pointer;">
                            <label for="continuous_${block.id}" style="font-size: 0.85rem; color: var(--text-main); font-weight: 500; cursor: pointer; margin: 0;">
                                Continuous <span style="color: var(--text-muted); font-weight: 400;">(Single context/plot)</span>
                            </label>
                        </div>
                        
                        ${block.continuous ? `
                            <button onclick="addSubBlock(${block.id})" class="btn btn-secondary" style="padding: 0.4rem 0.8rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.25rem;">
                                <i data-lucide="plus" style="width: 16px; height: 16px;"></i> Add Question Type
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    lucide.createIcons();
}

async function generateWorksheet() {
    const title = document.getElementById('worksheetTitle').value;
    const grade = document.getElementById('targetGrade').value;
    const subject = document.getElementById('targetSubject').value;
    
    if (!title || questionBlocks.length === 0) {
        alert('Please add a title and at least one question block');
        return;
    }
    
    document.getElementById('loading').style.display = 'flex';
    
    try {
        const response = await fetch('/api/generate-worksheet', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                grade: grade,
                subject: subject,
                title: title,
                question_blocks: questionBlocks
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('âœ¨ Worksheet generated successfully!\n\nCheck your /worksheets folder.');
            questionBlocks = [];
            renderQuestionBlocks();
            document.getElementById('generateBtn').disabled = true;
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    } catch (error) {
        alert('Failed to generate worksheet: ' + error.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}
</script>
{% endblock %}