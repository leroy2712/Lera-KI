{% extends "base.html" %}
{% block title %}Grade Worksheet - Lera-KI{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Grade Worksheet</h1>
    <p>Upload or snap photos of student answers for AI-powered grading</p>
</div>

<div class="grading-container">
    <div class="grading-form">
        <form id="gradingForm">
            <div class="form-group">
                <label for="grade">Grade Level</label>
                <input type="number" id="grade" name="grade" min="1" max="12" value="3" required>
            </div>

            <div class="form-group">
                <label for="subject">Subject</label>
                <input type="text" id="subject" name="subject" value="Math" required>
            </div>

            <div class="form-group">
                <label for="worksheetTitle">Worksheet Title/Topic</label>
                <input type="text" id="worksheetTitle" placeholder="e.g., Addition and Subtraction Practice" required>
            </div>

            <div class="form-group">
                <label>Student Worksheet Images</label>
                
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('galleryInput').click()">Browse Gallery</button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('cameraInput').click()">Take Photo</button>
                </div>
                
                <input type="file" id="galleryInput" accept="image/png, image/jpeg, image/jpg, image/webp" multiple style="display: none;">
                <input type="file" id="cameraInput" accept="image/png, image/jpeg, image/jpg, image/webp" capture="environment" style="display: none;">
                
                <div id="imagePreviewContainer" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                
                <small style="color: #666; display: block; margin-top: 10px;">You can mix gallery uploads and fresh camera photos. Add as many pages as needed.</small>
            </div>

            <div class="form-group">
                <label for="answerKey">Answer Key (Optional)</label>
                <textarea id="answerKey" rows="8" placeholder="Provide correct answers if available:

1. 8
2. 5
3. 9 apples

This helps the AI verify accuracy more precisely."></textarea>
            </div>

            <button type="submit" class="btn btn-primary btn-large">Grade Worksheet</button>
        </form>
    </div>

    <div id="gradingResults" class="results-container" style="display: none;">
        <h2>Grading Results</h2>
        <div id="resultsContent"></div>
        <button onclick="window.print()" class="btn btn-secondary">Print Results</button>
        <button onclick="resetForm()" class="btn btn-secondary">Grade Another</button>
    </div>
</div>

<div id="loading" class="loading" style="display: none;">
    <div class="spinner"></div>
    <p>Grading worksheet... This may take 10-20 seconds.</p>
</div>
{% endblock %}

{% block scripts %}
<script>
// Array to hold all uploaded/captured files
let selectedFiles = [];

const galleryInput = document.getElementById('galleryInput');
const cameraInput = document.getElementById('cameraInput');
const previewContainer = document.getElementById('imagePreviewContainer');

// Append new files to our array
function addFiles(files) {
    for (let i = 0; i < files.length; i++) {
        selectedFiles.push(files[i]);
    }
    renderPreviews();
    
    // Clear the inputs so the user can select the exact same file/take a new photo again if needed
    galleryInput.value = '';
    cameraInput.value = '';
}

galleryInput.addEventListener('change', (e) => addFiles(e.target.files));
cameraInput.addEventListener('change', (e) => addFiles(e.target.files));

// Remove file from the array
function removeFile(index) {
    selectedFiles.splice(index, 1);
    renderPreviews();
}

// Render the visual badges
function renderPreviews() {
    previewContainer.innerHTML = '';
    selectedFiles.forEach((file, index) => {
        const badge = document.createElement('div');
        badge.style.cssText = 'background: #e2e8f0; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; color: #334155;';
        
        const fileName = document.createElement('span');
        fileName.textContent = `Page ${index + 1}: ${file.name.substring(0, 15)}...`;
        
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.textContent = 'X';
        removeBtn.style.cssText = 'background: #ef4444; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 10px; font-weight: bold; display: flex; align-items: center; justify-content: center; padding: 0;';
        removeBtn.onclick = () => removeFile(index);
        
        badge.appendChild(fileName);
        badge.appendChild(removeBtn);
        previewContainer.appendChild(badge);
    });
}

document.getElementById('gradingForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Custom validation since the file inputs are hidden and don't use 'required' anymore
    if (selectedFiles.length === 0) {
        alert("Please upload or take a photo of at least one worksheet page.");
        return;
    }
    
    document.getElementById('loading').style.display = 'block';
    document.getElementById('gradingResults').style.display = 'none';
    
    const formData = new FormData();
    formData.append('grade', document.getElementById('grade').value);
    formData.append('subject', document.getElementById('subject').value);
    formData.append('worksheet_title', document.getElementById('worksheetTitle').value);
    formData.append('answer_key', document.getElementById('answerKey').value);
    
    // Append all files from our custom array
    for (let i = 0; i < selectedFiles.length; i++) {
        formData.append('student_images', selectedFiles[i]);
    }
    
    try {
        const response = await fetch('/api/grade-worksheet', {
            method: 'POST',
            body: formData 
        });
        
        const data = await response.json();
        
        if (data.success) {
            displayGradingResults(data.data);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        alert('Failed to grade worksheet: ' + error.message);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
});

function displayGradingResults(results) {
    const resultsContent = document.getElementById('resultsContent');
    
    let html = `
        <div class="grading-summary">
            <div class="score-card ${results.percentage >= 80 ? 'excellent' : results.percentage >= 60 ? 'good' : 'needs-improvement'}">
                <h3>Overall Score</h3>
                <div class="score-large">${results.score}/${results.total_questions}</div>
                <div class="percentage">${results.percentage}%</div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-label">Correct</span>
                    <span class="stat-value correct">${results.correct_count}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Incorrect</span>
                    <span class="stat-value incorrect">${results.incorrect_count}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Partial</span>
                    <span class="stat-value partial">${results.partial_count}</span>
                </div>
            </div>
        </div>
        
        <div class="detailed-feedback">
            <h3>Detailed Feedback</h3>
    `;
    
    results.questions.forEach((q, idx) => {
        const statusClass = q.status === 'correct' ? 'correct' : 
                           q.status === 'incorrect' ? 'incorrect' : 'partial';
        
        html += `
            <div class="question-feedback ${statusClass}">
                <div class="question-header">
                    <span class="question-number">Question ${idx + 1}</span>
                    <span class="status-badge ${statusClass}">${q.status.toUpperCase()}</span>
                    <span class="points">${q.points_earned}/${q.points_possible} pts</span>
                </div>
                
                <div class="question-content">
                    <p><strong>Question:</strong> ${q.question || 'N/A'}</p>
                    <p><strong>Student Answer:</strong> ${q.student_answer}</p>
                    ${q.correct_answer ? `<p><strong>Correct Answer:</strong> ${q.correct_answer}</p>` : ''}
                </div>
                
                <div class="feedback-text">
                    <strong>Feedback:</strong> ${q.feedback}
                </div>
            </div>
        `;
    });
    
    html += `
        </div>
        
        <div class="teacher-notes">
            <h3>Teacher Notes</h3>
            <p>${results.overall_feedback}</p>
            ${results.recommendations ? `
                <h4>Recommendations:</h4>
                <ul>
                    ${results.recommendations.map(r => `<li>${r}</li>`).join('')}
                </ul>
            ` : ''}
        </div>
    `;
    
    resultsContent.innerHTML = html;
    document.getElementById('gradingResults').style.display = 'block';
    document.getElementById('gradingResults').scrollIntoView({ behavior: 'smooth' });
}

function resetForm() {
    document.getElementById('gradingForm').reset();
    document.getElementById('gradingResults').style.display = 'none';
    
    // Clear the file array and preview UI
    selectedFiles = [];
    renderPreviews();
    
    window.scrollTo({ top: 0, behavior: 'smooth' });
}
</script>
{% endblock %}